!function(t){var e,a;e=function(){function e(e,a){this.settings=t.extend({},t.fn.turntable.defaults,a),this.el=t(e),this.init()}return e.prototype={PI:Math.PI,init:function(){var t=this.initElement();this.renderCanvas(t.face,t.pointer),this.startTurntable()},initElement:function(){var t=this.el.width();this.el.height(t),this.faceCanvas=this.el.children(".turntable-face");var e={face:this.faceCanvas.attr({width:t,height:t})[0].getContext("2d"),pointer:this.el.children(".turntable-pointer").attr({width:.2236*t,height:.2774*t})[0].getContext("2d")};return this.images={gift:document.getElementById("turntableGift"),smile:document.getElementById("turntableSmile"),pointer:document.getElementById("turntablePointer")},e},renderCanvas:function(t,e){var a,i,n,s,r=this.el.width()/2,o=.91*r,l=.06*r,h=this.PI/18,f=this.settings.items.length,d=.154*r,g=.189*r;for(t.clearRect(0,0,2*r,2*r),t.translate(r,r),t.save(),t.arc(0,0,o,0,2*this.PI),t.lineWidth=l,t.shadowBlur=l,t.shadowColor="#691c14",t.strokeStyle="#691c14",t.stroke(),l=.015*r,t.shadowBlur=l,t.shadowColor="#fecb02",t.fillStyle="#fecb02",i=n=0;i<36;++i,n+=h)t.beginPath(),t.arc(o*Math.sin(n),-o*Math.cos(n),l,0,2*this.PI),t.fill();for(o=.87*r,l=.02*r,t.beginPath(),t.arc(0,0,o,0,2*this.PI),t.shadowBlur=0,t.lineWidth=l,t.strokeStyle="#fc5d01",t.stroke(),o=.86*r,t.beginPath(),t.arc(0,0,o,0,2*this.PI),s=t.createRadialGradient(0,0,0,0,0,o),s.addColorStop(0,"#ffd267"),s.addColorStop(1,"#fdc236"),t.fillStyle=s,t.fill(),h=2*this.PI/f,s=t.createRadialGradient(0,0,0,0,0,o),s.addColorStop(0,"#ffd13d"),s.addColorStop(1,"#ff9c01"),t.fillStyle=s,i=0,n=h;i<f;++i,n+=h)1&i||(t.beginPath(),t.arc(0,0,o,n,n+h),t.lineTo(0,0),t.closePath(),t.fill());for(t.lineWidth=.004*r,t.strokeStyle="#fc5d01",t.beginPath(),i=n=0;i<f;++i,n+=h)t.moveTo(0,0),t.lineTo(o*Math.sin(n),-o*Math.cos(n));for(t.stroke(),o=.805*r,a=.571*r,t.restore(),t.save(),t.font=.35*a*Math.tan(h/2)+"px Helvetica",t.textBaseline="top",t.textAlign="center",t.fillStyle="#691c14",t.rotate(-h/2),i=0;i<f;++i)t.rotate(h),"gift"===this.settings.items[i].img?(this.images.gift.onload=function(){t.drawImage(this,-d/2,-o,d,g)},t.drawImage(this.images.gift,-d/2,-o,d,g)):"smile"===this.settings.items[i].img&&(this.images.smile.onload=function(){t.drawImage(this,-d/2,-o,d,d)},t.drawImage(this.images.smile,-d/2,-o,d,d)),t.fillText(this.settings.items[i].text,0,-a);o=.4472*r,a=.5548*r,this.images.pointer.onload=function(){e.drawImage(this,0,0,o,a)},e.drawImage(this.images.pointer,0,0,o,a)},startTurntable:function(){var e=this;e.phoD=t("#phoDialogue"),e.rstD=t("#rstDialogue"),e.btn=this.el.children("#turntable-btn"),e.remainingNumber=t("#remainingNumber"),e.shareBtn=t(".share-btn"),e.shareGuide=t(".share-guide"),e.guideImg=t(".guide-img"),e.isRotating=!1,e.btn.on("click tap",function(){e.isRotating||e.phoD.show()}),t("#pho-submit").on("click tap",function(){this.preventDefault,e.phoD.hide();var t=parseInt(e.remainingNumber.text());isNaN(t)||t<=0||(e.remainingNumber.text(t-1),e.rotate())})},rotate:function(){if(!this.isRotating){var t=this;t.isRotating=!0,t.faceCanvas.addClass("rotating"),setTimeout(function(){t.rotateTo()},800)}},rotateTo:function(t){var e=this;if(e.faceCanvas.hasClass("rotating")){isNaN(t)&&(t=a.randRange(0,e.settings.items.length));var i=360*(a.randRange(6,8)-(t+.5)/e.settings.items.length);e.faceCanvas.removeClass("rotating").css({"-webkit-transform":"rotate("+i+"deg)","-moz-transform":"rotate("+i+"deg)","-ms-transform":"rotate("+i+"deg)","-o-transform":"rotate("+i+"deg)",transform:"rotate("+i+"deg)"}).addClass("rotateTo"),setTimeout(function(){e.rstD.show(),"smile"===e.settings.items[t].img?(e.rstD.find("#rst-success").hide(),e.rstD.find("#rst-failed").show()):(e.rstD.find("#rst-failed").hide(),e.rstD.find("#rst-success").show(),e.rstD.find("#rstNum").html(e.settings.items[t].text));var a=parseInt(e.remainingNumber.text());a>0?e.shareBtn.text("再来一次"):e.shareBtn.text("分享活动"),e.shareBtn.off("click tap").on("click tap",function(){a>0?e.rstD.hide():(e.shareGuide.show(),e.guideImg.show())}),e.faceCanvas.removeClass("rotateTo"),e.isRotating=!1},5200)}},pointTo:function(t){var e=this;if(e.faceCanvas.hasClass("rotating")){isNaN(t)&&(t=a.randRange(0,e.settings.items.length));var i=-360*(t+.5)/e.settings.items.length;e.faceCanvas.css({"-webkit-transform":"rotate("+i+"deg)","-moz-transform":"rotate("+i+"deg)","-ms-transform":"rotate("+i+"deg)","-o-transform":"rotate("+i+"deg)",transform:"rotate("+i+"deg)"})}}},e}(),a={drawImage:function(t,e){return t.complete?void e.call(t):void(t.onload=function(){e.call(t)})},randRange:function(t,e){return Math.floor(this.rand()*(e-t)+t)},rand:function(){var t=(new Date).getTime();return t=(9301*t+49297)%233280,t/233280}},t.fn.turntable=function(a){return this.each(function(){var i=t(this),n=t.fn.turntable.lookup[i.data("turntable")];n||(t.fn.turntable.lookup[++t.fn.turntable.lookup.i]=new e(i,a),i.data("turntable",t.fn.turntable.lookup.i),n=t.fn.turntable.lookup[i.data("turntable")]),"string"==typeof a&&n[a]()})},t.fn.turntable.lookup={i:0},t.fn.turntable.defaults={}}(Zepto);